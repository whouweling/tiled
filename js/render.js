// Generated by CoffeeScript 1.10.0
(function() {
  window.Render = (function() {
    function Render(world, content) {
      this.world = world;
      this.content = content;
      this.tile_width = 36;
      this.tile_height = this.tile_width / 2;
      this.height_multiplier = 14;
      this.el_width = 73;
      this.el_height = 146;
      this.x_offset = 0;
      this.y_offset = 0;
      this.viewport_offset_x = 0;
      this.viewport_offset_y = 0;
      this.viewport_width = 10;
      this.viewport_height = 10;
      this.zoom = 1;
      this.map_context = document.getElementById("map").getContext("2d");
      this.items_context = document.getElementById("items").getContext("2d");
      this.fx_context = document.getElementById("fx").getContext("2d");
    }

    Render.prototype.resize = function() {
      this.viewport_width = parseInt(window.innerWidth / this.tile_width / 2, 10);
      this.viewport_height = parseInt(window.innerHeight / this.tile_height / 2, 10);
      this.viewport_offset_x = window.innerWidth / 2;
      return this.viewport_offset_y = 0;
    };

    Render.prototype.update = function() {
      this.tiles_resource = this.content.images.tiles;
      this.update_map();
      return this.update_fx();
    };

    Render.prototype.update_fx = function() {
      var effect, height, i, ix, iy, len, ref, results, tile;
      return;
      this.fx_context.clearRect(0, 0, 2000, 2000);
      ref = window.effects;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        effect = ref[i];
        if (!effect) {
          continue;
        }
        effect.run();
        ix = effect.x * this.tile_width - (effect.y * this.tile_width);
        iy = effect.y * this.tile_height + (effect.x * this.tile_height);
        height = this.world.map[effect.x][effect.y].get_vertical_offset();
        tile = this.content.sprites[effect.tile][1];
        results.push(this.fx_context.drawImage(tile, ix + this.viewport_offset_x, (iy + this.viewport_offset_y - height * 3 - 10) + effect.viewport_offset_y));
      }
      return results;
    };

    Render.prototype.draw_tile = function(context, tile, x, y, height, light) {
      if (light < 1) {
        light = 1;
      }
      if (light > 10) {
        light = 10;
      }
      if (!light) {
        light = 1;
      }
      return context.drawImage(this.tiles_resource[light], tile * this.el_width, 0, this.el_width, this.el_height, (x * this.zoom) + this.viewport_offset_x, (y * this.zoom) + this.viewport_offset_y - (height * this.zoom) * this.height_multiplier, this.el_width * this.zoom, this.el_height * this.zoom);
    };

    Render.prototype.update_map = function() {
      var height, i, ix, iy, light, ox, oy, ref, results, tile, x, y;
      this.map_context.clearRect(0, 0, 2000, 2000);
      results = [];
      for (x = i = 1, ref = this.viewport_width; 1 <= ref ? i <= ref : i >= ref; x = 1 <= ref ? ++i : --i) {
        results.push((function() {
          var j, ref1, results1;
          results1 = [];
          for (y = j = 1, ref1 = this.viewport_height; 1 <= ref1 ? j <= ref1 : j >= ref1; y = 1 <= ref1 ? ++j : --j) {
            ox = x + this.x_offset;
            oy = y + this.y_offset;
            if (ox < 1) {
              continue;
            }
            if (oy < 1) {
              continue;
            }
            if (ox > this.world.width) {
              continue;
            }
            if (oy > this.world.height) {
              continue;
            }
            tile = this.world.map[ox][oy].tile;
            height = this.world.map[ox][oy].get_vertical_offset();
            if (this.world.map[ox][oy].height < this.world.water_level) {
              height = 0;
            }
            ix = x * this.tile_width - (y * this.tile_width);
            iy = y * this.tile_height + (x * this.tile_height);
            light = this.world.light[ox][oy];
            this.draw_tile(this.map_context, tile, ix, iy, height, light);
            this.map_context.fillStyle = '#ccc';
            if (this.world.task[ox][oy]) {
              if (!this.world.items[ox][oy]) {
                this.map_context.fillText(this.world.task[ox][oy].abbr, ix + this.viewport_offset_x + 17, (iy + this.viewport_offset_y - height * 3) + 85);
              }
            }
            if (this.world.items[ox][oy]) {
              tile = this.world.items[ox][oy].get_tile();
              this.draw_tile(this.map_context, tile, ix, iy, height, light);
              if (this.world.items[ox][oy].count > 1) {
                this.map_context.fillText(this.world.items[ox][oy].count, ix + this.viewport_offset_x + 17, (iy + this.viewport_offset_y - height * 3) + 85);
              }
            }
            if (this.world.actors[ox][oy]) {
              tile = this.world.actors[ox][oy].get_tile();
              this.draw_tile(this.map_context, tile, ix, iy, height, light);
              if (this.world.actors[ox][oy].carry) {
                tile = this.world.actors[ox][oy].carry.get_tile();
                results1.push(this.draw_tile(this.map_context, tile, ix, iy, height + 1, light));
              } else {
                results1.push(void 0);
              }
            } else {
              results1.push(void 0);
            }
          }
          return results1;
        }).call(this));
      }
      return results;
    };

    return Render;

  })();

}).call(this);

//# sourceMappingURL=render.js.map
